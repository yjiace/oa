/*! For license information please see useradmin.js.LICENSE.txt */
layui.define(["table","form"],(function(e){layui.$;var o=layui.admin,a=layui.view,l=layui.table,t=layui.form,n=function(e,o){return Object.keys(e).filter((function(e){return e.includes("limits")})).map((function(e){return parseInt(e.split("[")[1],10)})).map((function(e){return o[e].id}))},r=function(e,o,a){var l=(o||[]).map((function(e){return e.id}));return console.log(l),l.forEach((function(o){var l=a.findIndex((function(e){return+e.id==+o}));l>-1&&(e.allList[+l].checked=!0)})),e};l.render({elem:"#LAY-user-back-manage",cols:[[{type:"checkbox",fixed:"left"},{field:"username",title:"登录名"},{field:"name",title:"真实姓名"},{field:"phone",title:"手机"},{field:"mobile",title:"电话"},{field:"company",title:"单位"},{field:"position",title:"职位"},{field:"createTime",title:"创建时间",sort:!0},{title:"操作",width:280,align:"center",fixed:"right",toolbar:"#table-useradmin-admin"}]],url:"/sys/user/findAll",headers:{Authorization:layui.data("layuiAdmin").Authorization},page:!0,limit:30,response:{statusCode:200},parseData:function(e){return 500===e.code&&"不允许访问"===e.data?(layer.msg("无权限访问"),{code:200,msg:e.data,data:[]}):{code:e.code,msg:e.msg,count:e.data.totalElements,data:window.utils.addPermission(e.data.content).filter((function(e){return console.log(e),e.createTime=window.utils.format(null,e.createTime),"Y"!==e.isDelete}))}},done:function(e,a,l){window.utils.dealCode(e.code,o),console.log(e),console.log(a),console.log(l)},text:{none:"暂无数据"}}),l.on("tool(LAY-user-back-manage)",(function(e){var n=e.data;"del"===e.event?layer.confirm("确定删除此管理员？",(function(a){console.log(e);var l=layer.load(1);o.req({url:"/sys/user/delete",method:"DELETE",data:{username:n.username},done:function(o){console.log(o),layer.close(l),200===o.code?(layer.msg("操作成功"),e.del(),layer.close(a),layui.table.reload("LAY-user-back-manage")):layer.msg("操作失败")}})})):"edit"===e.event?o.popup({title:"编辑管理员",area:["420px","600px"],id:"LAY-popup-user-add",success:function(e,l){a(this.id).render("user/administrators/adminform",n).done((function(){t.render(null,"layuiadmin-form-admin"),t.on("submit(LAY-user-back-submit)",(function(e){var a=e.field,t=layer.load(1);o.req({url:"/sys/user/update",method:"post",data:a,done:function(e){layer.close(t),console.log(e),200===e.code?(layer.msg("操作成功"),layui.table.reload("LAY-user-back-manage"),layer.close(l)):layer.msg("操作失败")}})}))}))}}):"reset"===e.event?layer.confirm("确定重置此账号的密码？",(function(a){var l=layer.load(1);console.log(e),o.req({url:"/sys/user/resetPassword",method:"POST",data:{username:n.username},done:function(e){layer.close(l),console.log(e),200===e.code?(layer.msg("操作成功"),layer.close(a),layui.table.reload("LAY-user-back-manage")):layer.msg("操作失败")}})})):"setRole"===e.event&&o.popup({title:"设置用户角色",area:["600px","430px"],id:"car_apply",success:function(e,r){a(this.id).render("user/administrators/selectRole",{}).done((function(){t.render(null,"createApply_form"),l.on("tool(LAY-user-setRole)",(function(e){var a=e.data;if(console.log(n),"edit"===e.event){var l=layer.load(1);o.req({url:"/sys/user/updateRole",method:"POST",data:{roles:a.id,username:n.username},done:function(e){layer.close(l),200===e.code?(layer.msg("操作成功"),layui.table.reload("LAY-user-back-manage")):layer.msg("操作失败"),layer.close(r)}})}}))}))}})})),l.render({elem:"#LAY-user-back-role",cols:[[{type:"checkbox",fixed:"left"},{field:"name",title:"角色名"},{field:"comments",title:"具体描述"},{title:"操作",width:150,align:"center",fixed:"right",toolbar:"#table-useradmin-admin"}]],url:"/sys/role/findAll",headers:{Authorization:layui.data("layuiAdmin").Authorization},page:!0,limit:30,response:{statusCode:200},parseData:function(e){return 500===e.code&&"不允许访问"===e.data?(layer.msg("无权限访问"),{code:200,msg:e.data,data:[]}):{code:e.code,msg:e.msg,count:e.data.totalElements,data:window.utils.addPermission(e.data.content).filter((function(e){return e.createTime=window.utils.format(null,e.createTime),"Y"!==e.isDelete}))}},done:function(e,a,l){window.utils.dealCode(e.code,o),console.log(e),console.log(a),console.log(l)},text:{none:"暂无数据"}}),l.on("tool(LAY-user-back-role)",(function(e){var l=JSON.parse(JSON.stringify(e.data));"del"===e.event?layer.confirm("确定删除此角色？",(function(a){var t=layer.load(1);o.req({method:"DELETE",url:"/sys/role/delete",data:{id:l.id},done:function(o){layer.close(t),200===o.code?(layer.msg("操作成功"),e.del(),layer.close(a),layui.table.reload("LAY-user-back-role")):layer.msg("操作失败")}})})):"edit"===e.event&&o.req({url:"/sys/role/findAllPermission",done:function(e){if(console.log(e),200===e.code){var i=[],s=["1","8","16"];e.data.forEach((function(e){s.includes(e.id)&&e.children.forEach((function(e){i.push(e)}))})),l.allList=i,o.popup({title:"编辑角色",area:["500px","600px"],id:"LAY-popup-user-add",success:function(e,s){var d=r(l,l.sysPermissions,i);console.log(d),a(this.id).render("user/administrators/roleform",d).done((function(){t.render(null,"layuiadmin-form-role"),t.on("submit(LAY-user-role-submit)",(function(e){var a=layer.load(1),t=e.field;console.log(t);var r=n(t,i);console.log(r),o.req({url:"/sys/role/update",method:"POST",data:{id:l.id,name:t.name,comments:t.comments,permissions:r.join(",")},done:function(e){layer.close(a),200===e.code?(layer.msg("操作成功"),layui.table.reload("LAY-user-back-role"),layer.close(s)):layer.msg("操作失败")}})}))}))}})}}})})),e("useradmin",{})}));