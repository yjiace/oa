/*! For license information please see useradmin.js.LICENSE.txt */
layui.define(["table","form"],(function(e){layui.$;var o=layui.admin,n=layui.view,t=layui.table,l=layui.form,a=function(e,o){return Object.keys(e).filter((function(e){return e.includes("limits")})).map((function(e){return parseInt(e.split("[")[1],10)})).map((function(e){return o[e].id}))},i=function(e,o,n){var t=(o||[]).map((function(e){return e.id}));return console.log(t),t.forEach((function(o){var t=n.findIndex((function(e){return+e.id==+o}));t>-1&&(e.allList[+t].checked=!0)})),e};t.render({elem:"#LAY-user-back-manage",cols:[[{type:"checkbox",fixed:"left"},{field:"username",title:"登录名"},{field:"name",title:"真实姓名"},{field:"phone",title:"手机"},{field:"mobile",title:"电话"},{field:"company",title:"单位"},{field:"position",title:"职位"},{field:"createTime",title:"创建时间",sort:!0},{title:"操作",width:280,align:"center",fixed:"right",toolbar:"#table-useradmin-admin"}]],url:"/sys/user/findAll",headers:{Authorization:layui.data("layuiAdmin").Authorization},page:!0,limit:30,response:{statusCode:200},parseData:function(e){return{code:e.code,msg:e.msg,count:e.data.totalElements,data:window.utils.addPermission(e.data.content).filter((function(e){return console.log(e),e.createTime=window.utils.format(null,e.createTime),"Y"!==e.isDelete}))}},done:function(e,o,n){console.log(e),console.log(o),console.log(n)},text:{none:"暂无数据"}}),t.on("tool(LAY-user-back-manage)",(function(e){var a=e.data;"del"===e.event?layer.confirm("确定删除此管理员？",(function(n){console.log(e),o.req({url:"/sys/user/delete",method:"DELETE",data:{username:a.username},done:function(o){console.log(o),200===o.code?(layer.msg("操作成功"),e.del(),layer.close(n),layui.table.reload("LAY-user-back-manage")):layer.msg("操作失败")}})})):"edit"===e.event?o.popup({title:"编辑管理员",area:["420px","600px"],id:"LAY-popup-user-add",success:function(e,t){n(this.id).render("user/administrators/adminform",a).done((function(){l.render(null,"layuiadmin-form-admin"),l.on("submit(LAY-user-back-submit)",(function(e){var n=e.field;o.req({url:"/sys/user/update",method:"post",data:n,done:function(e){console.log(e),200===e.code&&(layui.table.reload("LAY-user-back-manage"),layer.close(t))}})}))}))}}):"reset"===e.event?layer.confirm("确定重置此账号的密码？",(function(n){console.log(e),o.req({url:"/sys/user/resetPassword",method:"POST",data:{username:a.username},done:function(e){console.log(e),200===e.code?(layer.msg("操作成功"),layer.close(n),layui.table.reload("LAY-user-back-manage")):layer.msg("操作失败")}})})):"setRole"===e.event&&o.popup({title:"设置用户角色",area:["600px","430px"],id:"car_apply",success:function(e,i){n(this.id).render("user/administrators/selectRole",{}).done((function(){l.render(null,"createApply_form"),t.on("tool(LAY-user-setRole)",(function(e){var n=e.data;console.log(a),"edit"===e.event&&o.req({url:"/sys/user/updateRole",method:"POST",data:{roles:n.id,username:a.username},done:function(e){200===e.code?(layer.msg("操作成功"),layui.table.reload("LAY-user-back-manage")):layer.msg("操作失败"),layer.close(i)}})}))}))}})})),t.render({elem:"#LAY-user-back-role",cols:[[{type:"checkbox",fixed:"left"},{field:"name",title:"角色名"},{field:"comments",title:"具体描述"},{title:"操作",width:150,align:"center",fixed:"right",toolbar:"#table-useradmin-admin"}]],url:"/sys/role/findAll",headers:{Authorization:layui.data("layuiAdmin").Authorization},page:!0,limit:30,response:{statusCode:200},parseData:function(e){return{code:e.code,msg:e.msg,count:e.data.totalElements,data:window.utils.addPermission(e.data.content).filter((function(e){return e.createTime=window.utils.format(null,e.createTime),"Y"!==e.isDelete}))}},done:function(e,o,n){console.log(e),console.log(o),console.log(n)},text:{none:"暂无数据"}}),t.on("tool(LAY-user-back-role)",(function(e){var t=JSON.parse(JSON.stringify(e.data));"del"===e.event?layer.confirm("确定删除此角色？",(function(n){o.req({method:"DELETE",url:"/sys/role/delete",data:{id:t.id},done:function(o){200===o.code?(layer.msg("操作成功"),e.del(),layer.close(n),layui.table.reload("LAY-user-back-role")):layer.msg("操作失败")}})})):"edit"===e.event&&o.req({url:"/sys/role/findAllPermission",done:function(e){if(console.log(e),200===e.code){var r=[],s=["1","8","16"];e.data.forEach((function(e){s.includes(e.id)&&e.children.forEach((function(e){r.push(e)}))})),t.allList=r,o.popup({title:"编辑角色",area:["500px","600px"],id:"LAY-popup-user-add",success:function(e,s){var d=i(t,t.sysPermissions,r);console.log(d),n(this.id).render("user/administrators/roleform",d).done((function(){l.render(null,"layuiadmin-form-role"),l.on("submit(LAY-user-role-submit)",(function(e){var n=e.field;console.log(n);var l=a(n,r);console.log(l),o.req({url:"/sys/role/update",method:"POST",data:{id:t.id,name:n.name,comments:n.comments,permissions:l.join(",")},done:function(e){200===e.code?(layui.table.reload("LAY-user-back-role"),layer.close(s)):layer.msg("操作失败")}})}))}))}})}}})})),e("useradmin",{})}));