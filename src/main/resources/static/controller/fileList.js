layui.define(["table","admin","form","fileManager","upload"],(function(e){var a=layui.$,i=layui.admin,t=layui.table,n=(layui.view,layui.form),l=(layui.upload,layui.fileManager);l.render({elem:"#fileManager",method:"get",id:"fmTest",btn_upload:!1,btn_create:!1,icon_url:"ico/",url:"/file/findAll",headers:{Authorization:layui.data("layuiAdmin").Authorization},thumb:{nopic:"ico/misc-no.png",width:100,height:100},parseData:function(e){if(500===e.code&&"不允许访问"===e.data)return layer.msg("无权限访问"),{code:200,msg:e.data,data:[]};console.log(e);var i=[];return i.code=0,i.data=e.data.content.map((function(e){var i=e.fileName.split(".")[1];return a.extend(e,{thumb:e.url,path:e.url,name:e.fileName,type:["jpg","png","gif","jpeg"].includes(i)?"misc":i})})),i.count=e.data.totalElements,i},done:function(e,t,n){a.contextMenu({selector:".fileManager li",items:{view:{name:"预览文件",callback:function(a,i){console.log(a,i,e);var t=i.$trigger.data().index,n=e.data[t];window.utils.viewFile(n)}},download:{name:"下载文件",callback:function(a,t){console.log(a,t,e);var n=t.$trigger.data().index,l=e.data[n];(function(e,a){if(!window.Blob||!window.URL)return i.reqAsync({url:"/file/getToken",data:{id:e}}).then((function(e){200===e.code?window.open("/file/downloadFileByToken?token="+e.data):layer.msg("无权限下载")}));var t=a.split(".");return window.axios.request({url:"/file/downloadFile",method:"get",headers:{Authorization:layui.data("layuiAdmin").Authorization},responseType:"arraybuffer",params:{id:e}}).then((function(e){var i=new Blob([e.data],{type:window.utils.mime[t[1]]}),n=URL.createObjectURL(i),l=document.createElement("a");l.href=n,l.download=a,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(l.href)}))})(l.id,l.fileName).then((function(e){}))}},del:{name:"删除文件",callback:function(a,t){var n=t.$trigger.data().index,o=e.data[n];layer.confirm("确定要删除"+o.fileName+"?",(function(e){i.reqAsync({url:"/file/deleteFile",method:"DELETE",data:{id:o.id},done:function(e){200===e.code&&(layer.msg("操作成功"),l.reload("fmTest"))}})}))}}}})},page:{limit:19,layout:["count","prev","page","next","limit","refresh","skip"]},where:{}}),t.on("tool(file_list_table)",(function(e){var a=e.data;console.log(a),"del"===e.event&&layer.confirm("确定要删除？",(function(e){i.reqAsync({url:"/file/deleteFile",method:"DELETE",data:{id:a.id},done:function(a){200===a.code&&(t.reload("file_list_table"),layer.close(e))}})})),e.event})),n.on("submit(LAY-user-back-search)",(function(e){var a=e.field,i={};a.documentNumber?i.search_AND_LIKE_documentNumber=a.documentNumber:i=null,t.reload("file_list_table",{where:i})})),e("fileList",{})}));