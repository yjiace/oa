layui.define(["table","admin","form","fileManager","upload"],(function(e){var a=layui.$,i=layui.admin,n=layui.table,t=(layui.view,layui.form),l=layui.upload,o=layui.fileManager;uploadInst=l.render({elem:"#fileManager",url:"/file/uploadFile",accept:"file",auto:!0,headers:{Authorization:layui.data("layuiAdmin").Authorization},choose:function(e){console.log(a(".layui-upload-file").get(0)),console.log(e);var i=e.pushFile(),n=Object.keys(i);n.forEach((function(e,a){a!==n.length-1&&delete i[e]})),file=i[n[n.length-1]],renderUpload({fileName:file.name})},done:function(e){200===e.code&&(layer.msg("成功发起审批"),window.history.back())},error:function(){}}),o.render({elem:"#fileManager",method:"get",id:"fmTest",btn_upload:!0,btn_create:!1,icon_url:"ico/",url:"/file/findAll",headers:{Authorization:layui.data("layuiAdmin").Authorization},thumb:{nopic:"ico/misc-no.png",width:100,height:100},parseData:function(e){console.log(e);var i=[];return i.code=0,i.data=e.data.content.map((function(e){var i=e.fileName.split(".")[1];return a.extend(e,{thumb:e.url,path:e.url,name:e.fileName,type:["jpg","png","gif","jpeg"].includes(i)?"misc":i})})),i.count=e.data.totalElements,i},done:function(e,n,t){a.contextMenu({selector:".fileManager li",items:{download:{name:"下载文件",callback:function(a,n){console.log(a,n,e);var t=n.$trigger.data().index,l=e.data[t];(function(e,a){if(!window.Blob||!window.URL)return i.reqAsync({url:"/file/getToken",data:{id:e}}).then((function(e){200===e.code?window.open("/file/downloadFileByToken?token="+e.data):layer.msg("无权限下载")}));var n=a.split(".");return window.axios.request({url:"/file/downloadFile",method:"get",headers:{Authorization:layui.data("layuiAdmin").Authorization},responseType:"arraybuffer",params:{id:e}}).then((function(e){var i=new Blob([e.data],{type:window.utils.mime[n[1]]}),t=URL.createObjectURL(i),l=document.createElement("a");l.href=t,l.download=a,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(l.href)}))})(l.id,l.fileName).then((function(e){}))}},del:{name:"删除文件",callback:function(a,n){var t=n.$trigger.data().index,l=e.data[t];layer.confirm("确定要删除"+l.fileName+"?",(function(e){i.reqAsync({url:"/file/deleteFile",method:"DELETE",data:{id:l.id},done:function(e){200===e.code&&(layer.msg("操作成功"),o.reload("fmTest"))}})}))}}}})},page:{limit:19,layout:["count","prev","page","next","limit","refresh","skip"]},where:{}}),n.on("tool(file_list_table)",(function(e){var a=e.data;console.log(a),"del"===e.event&&layer.confirm("确定要删除？",(function(e){i.reqAsync({url:"/file/deleteFile",method:"DELETE",data:{id:a.id},done:function(a){200===a.code&&(n.reload("file_list_table"),layer.close(e))}})})),e.event})),t.on("submit(LAY-user-back-search)",(function(e){var a=e.field,i={};a.documentNumber?i.search_AND_LIKE_documentNumber=a.documentNumber:i=null,n.reload("file_list_table",{where:i})})),e("fileList",{})}));