layui.define(["table","admin","form","laytpl","upload"],(function(e){var a=layui.$,t=layui.admin,o=layui.table,n=layui.view,i=layui.form,l=layui.upload,c=layui.laytpl,u=[],r=null,s=layui.router();function d(e){c(a("#apply_list").html()).render(e.concat([{}]),(function(e){a("#apply_list_view").html(e),a(".applyList_del").on("click",(function(e){var t=Number(a(this).data("type"));layer.confirm("真的删除么",(function(e){u.splice(t,1),d(u),layer.close(e)}))})),a(".applyList_edit").on("click",(function(e){var l=Number(a(this).data("type"));t.popup({title:"选择审批人",area:["600px","430px"],id:"car_apply",success:function(e,a){n(this.id).render("approve/selectPeople",{}).done((function(){i.render(null,"createApply_form"),o.on("tool(LAY-user-back-manage)",(function(e){var t=e.data;console.log(t),"edit"===e.event&&(u[l]={name:t.username},d(u),layer.close(a))}))}))}})})),a(".addPeople").on("click",(function(e){t.popup({title:"选择审批人",area:["600px","430px"],id:"car_apply",success:function(e,a){n(this.id).render("approve/selectPeople",{}).done((function(){i.render(null,"createApply_form"),o.on("tool(LAY-user-back-manage)",(function(e){var t=e.data;console.log(t),"edit"===e.event&&(u.push({name:t.username}),d(u),layer.close(a))}))}))}})}))}))}s.search&&s.search.id&&t.reqAsync({url:"/document/approval/findOneById",method:"GET",data:{id:s.search.id}}).then((function(e){var t;200===e.code?(console.log(e.data),t={documentNumber:e.data.attachmentFiles[0].documentNumber,securityClassification:e.data.attachmentFiles[0].securityClassification},setTimeout((function(){i.val("createApply_form",t),a("#reApply").val("重新提审")})),setTimeout((()=>{console.log(1),a("#upload_word").html('<i class="layui-icon">&#xe655;</i>'+e.data.attachmentFiles[0].fileName),d(e.data.documentApprovalNodes.map((function(a,t){return{name:a.user,comment:e.data.documentApprovalComments[t]}})))}),0)):(layer.msg("无权访问"),window.history.back())})),d(u);var p={},m=null;setTimeout((function(){m=l.render({elem:"#upload_word",url:"/document/approval/submitForApproval",data:p,accept:"file",auto:!1,headers:{Authorization:layui.data("layuiAdmin").Authorization},choose:function(e){console.log(a(".layui-upload-file").get(0)),console.log(e);var t=e.pushFile(),o=Object.keys(t);o.forEach((function(e,a){a!==o.length-1&&delete t[e]})),r=t[o[o.length-1]],a("#upload_word").html('<i class="layui-icon">&#xe655;</i>'+r.name)},done:function(e){200===e.code&&(layer.msg("成功发起审批"),window.history.back())},error:function(){}})}),0),i.on("submit(apply-submit)",(function(e){var a=e.field;s.search&&s.search.id;console.log(r);a.documentNumber,u.map((function(e){return e.name})),a.securityClassification;p.documentNumber=a.documentNumber,p.securityClassification=a.securityClassification,p.username=u.map((function(e){return e.name})),m.upload()})),e("fileApplyCreate",{})}));