layui.define(["table","admin","form","laytpl","upload"],(function(e){var a=layui.$,o=layui.admin,t=layui.table,n=layui.view,i=layui.form,l=layui.upload,c=layui.laytpl,r=[],u=null,s=layui.router();function d(e){c(a("#apply_list").html()).render(e.concat([{}]),(function(e){a("#apply_list_view").html(e),a(".applyList_del").on("click",(function(e){var o=Number(a(this).data("type"));layer.confirm("真的删除么",(function(e){r.splice(o,1),d(r),layer.close(e)}))})),a(".applyList_edit").on("click",(function(e){var l=Number(a(this).data("type"));o.popup({title:"选择审批人",area:["600px","430px"],id:"car_apply",success:function(e,a){n(this.id).render("approve/selectPeople",{}).done((function(){i.render(null,"createApply_form"),t.on("tool(LAY-user-back-manage)",(function(e){var o=e.data;console.log(o),"edit"===e.event&&(r[l]={name:o.username},d(r),layer.close(a))}))}))}})})),a(".addPeople").on("click",(function(e){o.popup({title:"选择审批人",area:["600px","430px"],id:"car_apply",success:function(e,a){n(this.id).render("approve/selectPeople",{}).done((function(){i.render(null,"createApply_form"),t.on("tool(LAY-user-back-manage)",(function(e){var o=e.data;console.log(o),"edit"===e.event&&(r.push({name:o.username}),d(r),layer.close(a))}))}))}})}))}))}s.search&&s.search.id&&o.reqAsync({url:"/document/approval/findOneById",method:"GET",data:{id:s.search.id}}).then((function(e){var o;200===e.code?(console.log(e.data),o={documentNumber:e.data.attachmentFiles[0].documentNumber,securityClassification:e.data.attachmentFiles[0].securityClassification},setTimeout((function(){i.val("createApply_form",o),a("#reApply").val("重新提审")})),setTimeout((()=>{console.log(1),a("#upload_word").html('<i class="layui-icon">&#xe655;</i>'+e.data.attachmentFiles[0].fileName),d(e.data.documentApprovalNodes.map((function(a,o){return{name:a.user,comment:e.data.documentApprovalComments[o]}})))}),0)):(layer.msg("无权访问"),window.history.back())})),d(r);var p={},m=l.render({elem:"#upload_word",url:"/document/approval/submitForApproval",data:p,accept:"file",auto:!1,headers:{Authorization:layui.data("layuiAdmin").Authorization},choose:function(e){console.log(a(".layui-upload-file").get(0)),console.log(e);var o=e.pushFile(),t=Object.keys(o);t.forEach((function(e,a){a!==t.length-1&&delete o[e]})),u=o[t[t.length-1]],a("#upload_word").html('<i class="layui-icon">&#xe655;</i>'+u.name)},done:function(e){200===e.code&&(layer.msg("成功发起审批"),window.history.back())},error:function(){}});i.on("submit(apply-submit)",(function(e){var a=e.field;s.search&&s.search.id;console.log(u);a.documentNumber,r.map((function(e){return e.name})),a.securityClassification;p.documentNumber=a.documentNumber,p.securityClassification=a.securityClassification,p.username=r.map((function(e){return e.name})),m.upload()})),e("fileApplyCreate",{})}));