layui.define(["table","admin","form","laytpl","upload"],(function(e){var a=layui.$,t=layui.admin,n=layui.table,o=layui.view,i=layui.form,l=layui.upload,r=layui.laytpl,c=[],u=null,s=layui.router();function d(e){r(a("#apply_list").html()).render(e.concat([{}]),(function(e){a("#apply_list_view").html(e),a(".applyList_del").on("click",(function(e){var t=Number(a(this).data("type"));layer.confirm("真的删除么",(function(e){c.splice(t,1),d(c),layer.close(e)}))})),a(".applyList_edit").on("click",(function(e){var l=Number(a(this).data("type"));t.popup({title:"选择审批人",area:["600px","430px"],id:"car_apply",success:function(e,a){o(this.id).render("approve/selectPeople",{}).done((function(){i.render(null,"createApply_form"),n.on("tool(LAY-user-back-manage)",(function(e){var t=e.data;console.log(t),"edit"===e.event&&(c[l]={name:t.username},d(c),layer.close(a))}))}))}})})),a(".addPeople").on("click",(function(e){t.popup({title:"选择审批人",area:["600px","430px"],id:"car_apply",success:function(e,a){o(this.id).render("approve/selectPeople",{}).done((function(){i.render(null,"createApply_form"),n.on("tool(LAY-user-back-manage)",(function(e){var t=e.data;console.log(t),"edit"===e.event&&(c.push({name:t.username}),d(c),layer.close(a))}))}))}})}))}))}function p(e){a(".fileList_div").show(),a("#filedList").html('<i class="layui-icon">&#xe655;</i>'+e.fileName)}s.search&&s.search.id&&t.reqAsync({url:"/approval/findOneById",method:"GET",data:{id:s.search.id}}).then((function(e){var t;200===e.code?(console.log(e.data),t={documentNumber:e.data.attachmentFiles[0].documentNumber,securityClassification:e.data.attachmentFiles[0].securityClassification},setTimeout((function(){i.val("createApply_form",t),a("#reApply").val("重新提审")})),setTimeout((()=>{console.log(1),p({fileName:e.data.attachmentFiles[0].fileName}),d(e.data.documentApprovalNodes.map((function(a,t){return{name:a.user,comment:e.data.documentApprovalComments[t]}})))}),0)):(layer.msg("无权访问"),window.history.back())})),d(c);var m={},f=null;setTimeout((function(){f=l.render({elem:"#upload_word",url:"/approval/submitForApproval",data:m,accept:"file",auto:!1,headers:{Authorization:layui.data("layuiAdmin").Authorization},choose:function(e){console.log(a(".layui-upload-file").get(0)),console.log(e);var t=e.pushFile(),n=Object.keys(t);n.forEach((function(e,a){a!==n.length-1&&delete t[e]})),p({fileName:(u=t[n[n.length-1]]).name})},done:function(e){200===e.code&&(layer.msg("成功发起审批"),window.history.back())},error:function(){}})}),0),i.on("submit(apply-submit)",(function(e){var a=e.field;s.search&&s.search.id;console.log(u),m.documentNumber=a.documentNumber,m.securityClassification=a.securityClassification,m.title=a.title,m.number=a.number,m.type="document",m.username=c.map((function(e){return e.name})),f.upload()})),i.verify({onlyone:function(e,a){var n="";return t.req({url:"/approval/checkNumber",async:!1,data:{number:e},done:function(e){n=!(200===e.code&&!e.data)&&"审批编号不能重复！"},error:function(){n="审批编号不能重复！"}}),n}}),e("fileApplyCreate",{})}));